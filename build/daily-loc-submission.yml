parameters:
  - name: TargetBranch
    type: string
    default: "user/ejohn/initLocPipeline"

jobs:
- job: Localization
  dependsOn: []
  pool:
    vmImage: 'windows-latest'
  steps:
  - task: AzureKeyVault@1
    inputs:
      azureSubscription: 'DevHomeAzureServiceConnection'
      KeyVaultName: 'DevHomeKeyVault'
      SecretsFilter: 'GitHubPAT'
      RunAsPreJob: false
      
  - checkout: self
    persistCredentials: true

  - task: powershell@2
    inputs:
      targetType: 'inline'
      script: |
        $repo = "https://$(GitHubPAT)@github.com/microsoft/DevHome.git"
        git remote add mirror $repo
        git remote

        git fetch mirror "${{ parameters.TargetBranch }}"
        git pull mirror "${{ parameters.TargetBranch }}"

  - task: MicrosoftTDBuild.tdbuild-task.tdbuild-task.TouchdownBuildTask@1
    displayName: Download Localization Files
    inputs:
      teamId: 71220
      authId: $(TouchdownAppId)
      authKey: $(TouchdownAppKey)
      resourceFilePath: |
        **\en-US\*.resw
        **\en-US\*.resx
      outputDirectoryRoot: LocOutput
      localizationTarget: false
      appendRelativeDir: true
      pseudoSetting: Included

  - task: PowerShell@2
    displayName: Move Loc files one level up
    inputs:
      targetType: inline
      script: >-
        $Files = Get-ChildItem . -R -Filter 'Resources.resw' | ? FullName -Like '*en-US\*\Resources.resw'

        $Files | % { Move-Item -Verbose $_.Directory $_.Directory.Parent.Parent -EA:Ignore }
      pwsh: true

  - task: powershell@2
    inputs:
      targetType: 'inline'
      script: |
        git add *.resw
        git add *.resx
        git config --global user.email "DevHomeLocalization@microsoft.com"
        git config --global user.name "Microsoft"
        git commit --message "Updating loc files"
        git status
        git branch
        git push "https://$(GitHubPAT)@github.com/microsoft/DevHome.git"

  # Saving one of these makes it really easy to inspect the loc output...
  - powershell: 'tar czf LocOutput.tar.gz LocOutput'
    displayName: 'Archive Loc Output for Submission'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: LocOutput'
    inputs:
      PathtoPublish: LocOutput.tar.gz
      ArtifactName: LocOutput